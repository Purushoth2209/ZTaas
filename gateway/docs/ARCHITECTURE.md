# JWT Verification Architecture

## Complete Flow Diagram

```
┌──────────────────────────────────────────────────────────────────┐
│                         CLIENT                                   │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         │ 1. Login
                         ▼
                  ┌──────────────┐
                  │   Backend    │
                  │  Port 5001   │
                  │              │
                  │ POST /auth/  │
                  │      login   │
                  └──────┬───────┘
                         │
                         │ 2. JWT (RS256)
                         │    signed with private key
                         ▼
┌──────────────────────────────────────────────────────────────────┐
│                         CLIENT                                   │
│                    (has JWT token)                               │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         │ 3. Request + JWT
                         │    Authorization: Bearer <token>
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    GATEWAY (Port 8081)                          │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │              identityMiddleware                           │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │ 1. Extract JWT from Authorization header           │  │ │
│  │  │ 2. Decode JWT to get 'kid'                         │  │ │
│  │  │ 3. Fetch public key from JWKS (cached)             │  │ │
│  │  │ 4. Verify signature with public key                │  │ │
│  │  │ 5. Validate claims (iss, aud, exp)                 │  │ │
│  │  │ 6. Extract identity (userId, username, role)       │  │ │
│  │  │ 7. Attach to req.identity                          │  │ │
│  │  │ 8. Continue (NEVER BLOCKS)                         │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │              Enhanced Logging                             │ │
│  │  method=GET path=/users user=admin role=admin            │ │
│  │  issuer=http://localhost:5001 status=200 latency=16ms    │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │              Proxy to Backend                             │ │
│  │  Forward request with original JWT                        │ │
│  └───────────────────────────────────────────────────────────┘ │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 4. Proxied request
                         │    (JWT still in header)
                         ▼
                  ┌──────────────┐
                  │   Backend    │
                  │  Port 5001   │
                  │              │
                  │ Validates    │
                  │ JWT again    │
                  │ (defense in  │
                  │  depth)      │
                  └──────┬───────┘
                         │
                         │ 5. Response
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    GATEWAY (Port 8081)                          │
│                    Returns response to client                   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 6. Response
                         ▼
┌──────────────────────────────────────────────────────────────────┐
│                         CLIENT                                   │
└──────────────────────────────────────────────────────────────────┘
```

## JWKS Key Fetching

```
┌─────────────────────────────────────────────────────────────────┐
│                    GATEWAY (Port 8081)                          │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │         jwtVerification.service.js                        │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │ Need public key for kid="backend-key-1"            │  │ │
│  │  │                                                     │  │ │
│  │  │ Check cache... NOT FOUND                           │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  └───────────────────────┬───────────────────────────────────┘ │
└──────────────────────────┼──────────────────────────────────────┘
                           │
                           │ GET /.well-known/jwks.json
                           ▼
                    ┌──────────────┐
                    │   Backend    │
                    │  Port 5001   │
                    │              │
                    │ Returns JWKS │
                    └──────┬───────┘
                           │
                           │ {
                           │   "keys": [{
                           │     "kid": "backend-key-1",
                           │     "kty": "RSA",
                           │     "n": "...",
                           │     "e": "AQAB"
                           │   }]
                           │ }
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                    GATEWAY (Port 8081)                          │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │         jwtVerification.service.js                        │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │ Cache public key for 10 minutes                    │  │ │
│  │  │ Use public key to verify JWT signature             │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Admin Configuration Flow

```
┌──────────────────────────────────────────────────────────────────┐
│                      Admin User / Dashboard                      │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         │ POST /admin/config/jwt
                         │ {
                         │   "issuer": "http://localhost:5001",
                         │   "jwksUri": "http://...",
                         │   "audience": "api-gateway"
                         │ }
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    GATEWAY (Port 8081)                          │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │         admin.jwt.routes.js                               │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │ POST /admin/config/jwt                             │  │ │
│  │  └─────────────────┬───────────────────────────────────┘  │ │
│  └────────────────────┼───────────────────────────────────────┘ │
│                       │                                         │
│  ┌────────────────────▼───────────────────────────────────────┐ │
│  │         config.service.js                                 │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │ Update in-memory configuration                     │  │ │
│  │  │ jwtConfig = { ...newConfig }                       │  │ │
│  │  │                                                     │  │ │
│  │  │ Takes effect IMMEDIATELY                           │  │ │
│  │  │ No restart required                                │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │         jwtVerification.service.js                        │ │
│  │  ┌─────────────────────────────────────────────────────┐  │ │
│  │  │ Next JWT verification uses new config              │  │ │
│  │  │ - New JWKS URI                                     │  │ │
│  │  │ - New issuer validation                            │  │ │
│  │  │ - New audience validation                          │  │ │
│  │  └─────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Read-Only Mode Decision Tree

```
                    ┌─────────────────┐
                    │ Request arrives │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ JWT in header?  │
                    └────┬───────┬────┘
                         │       │
                    NO   │       │   YES
                         │       │
                ┌────────▼──┐    │
                │ Log:      │    │
                │ "No JWT"  │    │
                │           │    │
                │ Continue  │    │
                │ (200 OK)  │    │
                └───────────┘    │
                                 │
                        ┌────────▼────────┐
                        │ Verify JWT      │
                        └────┬───────┬────┘
                             │       │
                        OK   │       │   FAIL
                             │       │
                    ┌────────▼──┐    │
                    │ Log:      │    │
                    │ "user=X"  │    │
                    │ "role=Y"  │    │
                    │           │    │
                    │ Attach    │    │
                    │ identity  │    │
                    │           │    │
                    │ Continue  │    │
                    │ (200 OK)  │    │
                    └───────────┘    │
                                     │
                            ┌────────▼────────┐
                            │ Log:            │
                            │ "JWT failed:    │
                            │  <reason>"      │
                            │                 │
                            │ Continue        │
                            │ (200 OK)        │
                            └─────────────────┘

                    ALL PATHS CONTINUE!
                    NEVER BLOCKS REQUESTS
```

## Component Interaction

```
┌─────────────────────────────────────────────────────────────────┐
│                         Gateway Components                       │
│                                                                  │
│  ┌──────────────────┐                                           │
│  │ default.jwt.     │                                           │
│  │ config.js        │                                           │
│  │ (defaults)       │                                           │
│  └────────┬─────────┘                                           │
│           │                                                      │
│           │ loads                                                │
│           ▼                                                      │
│  ┌──────────────────┐      read/write      ┌─────────────────┐ │
│  │ config.service   │◄────────────────────►│ admin.jwt.      │ │
│  │ .js              │                      │ routes.js       │ │
│  │ (runtime store)  │                      │ (admin API)     │ │
│  └────────┬─────────┘                      └─────────────────┘ │
│           │                                                      │
│           │ reads config                                         │
│           ▼                                                      │
│  ┌──────────────────┐                                           │
│  │ jwtVerification  │                                           │
│  │ .service.js      │                                           │
│  │ (JWKS + verify)  │                                           │
│  └────────┬─────────┘                                           │
│           │                                                      │
│           │ called by                                            │
│           ▼                                                      │
│  ┌──────────────────┐                                           │
│  │ identity.        │                                           │
│  │ middleware.js    │                                           │
│  │ (JWT extraction) │                                           │
│  └────────┬─────────┘                                           │
│           │                                                      │
│           │ used in                                              │
│           ▼                                                      │
│  ┌──────────────────┐                                           │
│  │ proxy.routes.js  │                                           │
│  │ (all requests)   │                                           │
│  └────────┬─────────┘                                           │
│           │                                                      │
│           │ forwards to                                          │
│           ▼                                                      │
│  ┌──────────────────┐                                           │
│  │ proxy.controller │                                           │
│  │ .js              │                                           │
│  │ (enhanced logs)  │                                           │
│  └──────────────────┘                                           │
└─────────────────────────────────────────────────────────────────┘
```

## Security Layers (Defense in Depth)

```
┌──────────────────────────────────────────────────────────────────┐
│                         CLIENT                                   │
└────────────────────────┬─────────────────────────────────────────┘
                         │
                         │ JWT Token
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    LAYER 1: GATEWAY                             │
│                    (Observability Only)                         │
│                                                                 │
│  ✓ Verify JWT signature                                        │
│  ✓ Validate claims (iss, aud, exp)                             │
│  ✓ Extract identity                                            │
│  ✓ Log user context                                            │
│  ✗ DOES NOT BLOCK                                              │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ JWT forwarded
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    LAYER 2: BACKEND                             │
│                    (Enforcement)                                │
│                                                                 │
│  ✓ Verify JWT signature                                        │
│  ✓ Validate claims                                             │
│  ✓ Enforce authorization                                       │
│  ✓ BLOCKS invalid requests                                     │
└─────────────────────────────────────────────────────────────────┘

Both layers verify independently!
Gateway = Observability
Backend = Enforcement
```
